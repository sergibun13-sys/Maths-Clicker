<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Clicker: Genius Edition</title>
    <style>
        :root {
            --primary: #4A90E2;       /* Azul Principal */
            --dark-blue: #2C3E50;
            --effect-color: #FF007F;  /* Magenta/Rosa Intenso para efectos */
            --grid-color: rgba(74, 144, 226, 0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            color: var(--dark-blue);
            display: flex;
            background-color: #f8fbfd;
            /* Patr√≥n de Papel Milimetrado */
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Fondo Matem√°tico Animado (Canvas) --- */
        #mathCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* --- Bot√≥n de M√∫sica --- */
        #btnMusic {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #btnMusic:hover { transform: scale(1.1); }
        #btnMusic.active { background: var(--primary); color: white; }

        /* --- Layout Principal --- */
        .main-layout {
            display: grid;
            grid-template-columns: 4fr 3fr;
            width: 100%;
            height: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- Panel Izquierdo: Juego --- */
        .game-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        .score-display {
            text-align: center;
            margin-bottom: 40px;
            z-index: 2;
            background: rgba(255,255,255,0.7);
            padding: 20px 40px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.8);
        }

        #score {
            font-size: 4.5rem;
            font-weight: 900;
            color: var(--primary);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        #rate {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-top: 10px;
        }

        #btnClick {
            width: 320px;
            height: 320px;
            border-radius: 50%;
            border: none;
            background: radial-gradient(circle at 30% 30%, #5DADE2, var(--primary));
            color: white;
            font-size: 2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 
                0 15px 35px rgba(74, 144, 226, 0.4),
                inset 0 0 20px rgba(255,255,255,0.3);
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #btnClick:active {
            transform: scale(0.94);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.5);
        }

        #clickPowerText {
            font-size: 1.2rem;
            font-weight: normal;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* Efectos Visuales */
        .float-number {
            position: absolute;
            color: var(--effect-color);
            font-weight: 900;
            font-size: 1.8rem;
            pointer-events: none;
            user-select: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
            z-index: 20;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.5) rotate(10deg); }
        }

        /* --- Panel Derecho: Tienda --- */
        .shop-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-left: 1px solid rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 25px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.05);
        }

        .shop-header {
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 0;
            margin-bottom: 20px;
            z-index: 5;
            border-bottom: 2px solid #eee;
        }

        .shop-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--dark-blue);
        }

        .section-header {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #95a5a6;
            margin: 25px 0 10px 0;
            font-weight: bold;
        }

        .upgrade-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #eef2f7;
            transition: all 0.2s;
        }

        .upgrade-card:hover {
            transform: translateX(-5px);
            border-color: var(--primary);
        }

        .upgrade-icon { font-size: 1.8rem; width: 50px; text-align: center; }
        .upgrade-details { flex: 1; }
        .upgrade-name { font-weight: 700; font-size: 1rem; }
        .upgrade-lvl { font-size: 0.75rem; background: var(--dark-blue); color: white; padding: 2px 6px; border-radius: 8px; margin-left: 5px;}
        .upgrade-desc { font-size: 0.8rem; color: #7f8c8d; }

        .btn-buy {
            background: #ecf0f1;
            color: var(--dark-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            min-width: 80px;
        }
        .btn-buy:hover:not(:disabled) { background: var(--primary); color: white; }
        .btn-buy:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Bot√≥n Bonus */
        #btnMathBonus {
            display: none;
            position: absolute;
            top: 20px;
            background: linear-gradient(45deg, #FF9F43, #EE5A24);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(238, 90, 36, 0.4);
            animation: bounce 1s infinite;
            z-index: 50;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-layout { display: block; overflow-y: auto; }
            body { overflow: auto; height: auto; }
            .game-panel { min-height: 80vh; }
            .shop-panel { min-height: 100vh; }
            #btnClick { width: 260px; height: 260px; }
            #btnMusic { top: 10px; right: 10px; width: 40px; height: 40px; font-size: 1.2rem; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; max-width: 90%; width: 350px;
        }
        .option-btn {
            display: block; width: 100%; margin: 10px 0; padding: 15px;
            border: 2px solid #eee; background: white; border-radius: 10px;
            font-size: 1.1rem; cursor: pointer;
        }
        .option-btn:hover { border-color: var(--primary); color: var(--primary); }
    </style>
</head>
<body>

    <!-- Fondo Animado -->
    <canvas id="mathCanvas"></canvas>

    <!-- Bot√≥n M√∫sica -->
    <button id="btnMusic" onclick="toggleMusic()">üîá</button>

    <div class="main-layout">
        
        <!-- JUEGO -->
        <div class="game-panel">
            <div class="score-display">
                <div id="score">0 <small style="font-size:0.4em">IQ</small></div>
                <div id="rate">0 IQ / seg</div>
            </div>

            <button id="btnMathBonus" onclick="showMathProblem()">
                üéÅ ¬°PROBLEMA BONUS!
            </button>

            <button id="btnClick" onmousedown="handleManualClick(event)" ontouchstart="handleManualClick(event)">
                <span>ESTUDIAR</span>
                <span id="clickPowerText">(+1 IQ)</span>
            </button>
        </div>

        <!-- TIENDA -->
        <div class="shop-panel">
            <div class="shop-header">
                <div class="shop-title">Tienda Acad√©mica</div>
            </div>
            <div class="section-header">HERRAMIENTAS DE ESTUDIO (CLICK)</div>
            <div id="clickUpgradesList"></div>
            <div class="section-header">M√âTODOS DE APRENDIZAJE (AUTO)</div>
            <div id="autoUpgradesList"></div>
        </div>
    </div>

    <!-- MODAL PREGUNTA -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color:var(--primary)">üß† C√°lculo R√°pido</h2>
            <p id="mathQuestion" style="font-size: 1.4rem; margin: 20px 0;">¬ø?</p>
            <div id="mathOptions"></div>
        </div>
    </div>

    <script>
        // --- 0. SISTEMA DE AUDIO GENERATIVO (Web Audio API) ---
        let audioCtx = null;
        let isPlaying = false;
        let nextNoteTime = 0;
        let tempo = 60; 
        const notes = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; // Escala Pentat√≥nica C Major

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playNote(freq, time) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.type = 'sine'; // Sonido suave tipo piano el√©ctrico
            osc.frequency.value = freq;
            
            // Envelope (ADSR simple)
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(0.1, time + 0.1); // Attack
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 2); // Decay largo y relajante

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start(time);
            osc.stop(time + 2);
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                // Elegir nota aleatoria suave
                const note = notes[Math.floor(Math.random() * notes.length)];
                // A veces no tocar nada para dar espacio (silencio)
                if (Math.random() > 0.2) {
                    playNote(note, nextNoteTime);
                    // Ocasionalmente tocar un acorde (otra nota)
                    if(Math.random() > 0.7) {
                        const harmony = notes[Math.floor(Math.random() * notes.length)];
                        playNote(harmony, nextNoteTime);
                    }
                }
                nextNoteTime += 0.5; // Cada medio segundo
            }
            if(isPlaying) requestAnimationFrame(scheduler);
        }

        function toggleMusic() {
            const btn = document.getElementById('btnMusic');
            if (isPlaying) {
                isPlaying = false;
                btn.innerHTML = 'üîá';
                btn.classList.remove('active');
                if(audioCtx) audioCtx.suspend();
            } else {
                initAudio();
                if(audioCtx.state === 'suspended') audioCtx.resume();
                isPlaying = true;
                nextNoteTime = audioCtx.currentTime;
                scheduler();
                btn.innerHTML = 'üéµ';
                btn.classList.add('active');
            }
        }

        // --- 1. VISUALES MATEM√ÅTICOS ---
        const canvas = document.getElementById('mathCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        const symbols = ['œÄ', '‚àë', '‚à´', '‚àö', '‚àû', '‚â†', '‚âà', '‚àÜ', 'Œ©', 'Œº', '‚àÇ', '‚àÖ', '‚àá', '‚àà', '‚àÄ', 'sin', 'cos', 'tan'];
        const particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() {
                this.reset();
            }
            reset() {
                this.x = Math.random() * width;
                this.y = height + Math.random() * 100;
                this.size = Math.random() * 15 + 10;
                this.symbol = symbols[Math.floor(Math.random() * symbols.length)];
                this.speed = Math.random() * 1 + 0.2;
                this.opacity = 0;
                this.maxOpacity = Math.random() * 0.4 + 0.1;
            }
            update() {
                this.y -= this.speed;
                // Fade in/out
                if(this.y > height * 0.8) this.opacity += 0.01;
                else if (this.y < height * 0.2) this.opacity -= 0.01;
                
                if(this.opacity > this.maxOpacity) this.opacity = this.maxOpacity;
                if(this.opacity < 0) this.opacity = 0;

                if (this.y < -50) this.reset();
            }
            draw() {
                ctx.fillStyle = `rgba(74, 144, 226, ${this.opacity})`;
                ctx.font = `bold ${this.size}px 'Courier New'`;
                ctx.fillText(this.symbol, this.x, this.y);
            }
        }

        function initParticles() {
            for(let i=0; i<50; i++) particles.push(new Particle());
        }
        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }
        initParticles();
        animateParticles();

        // --- 2. L√ìGICA DE JUEGO ---
        const upgradesConfig = [
            // Click
            { id: 'c1', type: 'click', name: 'L√°piz HB', icon: '‚úèÔ∏è', basePrice: 15, power: 1 },
            { id: 'c2', type: 'click', name: 'Subrayador', icon: 'üñçÔ∏è', basePrice: 50, power: 3 },
            { id: 'c3', type: 'click', name: 'Regla T', icon: 'üìè', basePrice: 150, power: 5 },
            { id: 'c4', type: 'click', name: 'Calculadora', icon: 'üìü', basePrice: 500, power: 15 },
            { id: 'c5', type: 'click', name: 'Comp√°s', icon: 'üìê', basePrice: 1200, power: 40 },
            { id: 'c6', type: 'click', name: 'Libro √Ålgebra', icon: 'üìò', basePrice: 3500, power: 100 },
            { id: 'c7', type: 'click', name: 'Microscopio', icon: 'üî¨', basePrice: 8000, power: 250 },
            { id: 'c8', type: 'click', name: 'Telescopio', icon: 'üî≠', basePrice: 20000, power: 600 },
            { id: 'c9', type: 'click', name: 'Superordenador', icon: 'üñ•Ô∏è', basePrice: 50000, power: 1500 },
            { id: 'c10',type: 'click', name: 'IA Cu√°ntica', icon: 'ü§ñ', basePrice: 150000, power: 5000 },
            // Auto
            { id: 'a1', type: 'auto', name: 'Notas Adhesivas', icon: 'üóíÔ∏è', basePrice: 25, power: 1 },
            { id: 'a2', type: 'auto', name: 'Apuntes Prestados', icon: 'üìë', basePrice: 100, power: 4 },
            { id: 'a3', type: 'auto', name: 'Grupo de Estudio', icon: 'üë•', basePrice: 600, power: 10 },
            { id: 'a4', type: 'auto', name: 'Profesor Particular', icon: 'üë®‚Äçüè´', basePrice: 1500, power: 30 },
            { id: 'a5', type: 'auto', name: 'Curso Online', icon: 'üíª', basePrice: 4000, power: 80 },
            { id: 'a6', type: 'auto', name: 'Biblioteca', icon: 'üèõÔ∏è', basePrice: 10000, power: 200 },
            { id: 'a7', type: 'auto', name: 'Laboratorio', icon: '‚öóÔ∏è', basePrice: 25000, power: 500 },
            { id: 'a8', type: 'auto', name: 'Observatorio', icon: 'üåå', basePrice: 60000, power: 1200 },
            { id: 'a9', type: 'auto', name: 'Universidad', icon: 'üéì', basePrice: 200000, power: 4000 },
            { id: 'a10',type: 'auto', name: 'Think Tank', icon: 'üß†', basePrice: 1000000, power: 10000 },
        ];

        let gameState = { iq: 0, clickPower: 1, autoRate: 0, upgrades: {} };
        upgradesConfig.forEach(u => gameState.upgrades[u.id] = 0);

        const elScore = document.getElementById('score');
        const elRate = document.getElementById('rate');

        function formatNum(n) {
            if (n >= 1e6) return (n/1e6).toFixed(2) + "M";
            if (n >= 1e3) return (n/1e3).toFixed(1) + "k";
            return Math.floor(n);
        }

        function updateStats() {
            let cp = 1, ar = 0;
            upgradesConfig.forEach(u => {
                let lvl = gameState.upgrades[u.id];
                if(lvl > 0) {
                    if(u.type === 'click') cp += u.power * lvl;
                    else ar += u.power * lvl;
                }
            });
            gameState.clickPower = cp;
            gameState.autoRate = ar;
        }

        function updateUI() {
            elScore.innerHTML = `${formatNum(gameState.iq)} <small style="font-size:0.4em">IQ</small>`;
            elRate.innerText = `${formatNum(gameState.autoRate)} IQ / seg`;
            document.getElementById('clickPowerText').innerText = `(+${formatNum(gameState.clickPower)} IQ)`;
            renderShop();
        }

        function renderShop() {
            const listC = document.getElementById('clickUpgradesList');
            const listA = document.getElementById('autoUpgradesList');
            listC.innerHTML = ''; listA.innerHTML = '';

            upgradesConfig.forEach(u => {
                const lvl = gameState.upgrades[u.id];
                const price = Math.floor(u.basePrice * Math.pow(1.15, lvl));
                const canBuy = gameState.iq >= price;

                const div = document.createElement('div');
                div.className = 'upgrade-card';
                div.innerHTML = `
                    <div class="upgrade-icon">${u.icon}</div>
                    <div class="upgrade-details">
                        <div class="upgrade-name">${u.name} <span class="upgrade-lvl">Nv.${lvl}</span></div>
                        <div class="upgrade-desc">+${formatNum(u.power)} ${u.type==='click'?'click':'IQ/s'}</div>
                    </div>
                    <button class="btn-buy" ${canBuy ? '' : 'disabled'} onclick="buy('${u.id}')">
                        ${formatNum(price)}
                    </button>
                `;
                if(u.type === 'click') listC.appendChild(div);
                else listA.appendChild(div);
            });
        }

        function buy(id) {
            const u = upgradesConfig.find(x => x.id === id);
            const lvl = gameState.upgrades[id];
            const price = Math.floor(u.basePrice * Math.pow(1.15, lvl));
            if(gameState.iq >= price) {
                gameState.iq -= price;
                gameState.upgrades[id]++;
                updateStats();
                updateUI();
            }
        }

        function handleManualClick(e) {
            if(e.type === 'touchmove') return; 
            e.preventDefault();

            gameState.iq += gameState.clickPower;
            updateUI();
            
            // Efecto visual
            let x, y;
            if(e.touches && e.touches.length > 0) { x = e.touches[0].clientX; y = e.touches[0].clientY; } 
            else { x = e.clientX; y = e.clientY; }
            createFloatingEffect(x, y);

            // Efecto Sonoro (si la m√∫sica est√° activa, a√±adimos un "ping" extra)
            if(isPlaying) playNote(notes[Math.floor(Math.random()*notes.length)] * 2, audioCtx.currentTime);
        }

        function createFloatingEffect(x, y) {
            const el = document.createElement('div');
            el.className = 'float-number';
            
            const showSymbol = Math.random() < 0.3;
            if (showSymbol) {
                const mathSym = ['‚àë', '‚à´', 'œÄ', '‚àö', 'x¬≤'][Math.floor(Math.random()*5)];
                el.innerText = `+${mathSym}`;
                el.style.fontSize = '2.2rem';
            } else {
                el.innerText = `+${formatNum(gameState.clickPower)}`;
            }
            
            const rx = x + (Math.random() - 0.5) * 50;
            const ry = y - 20;

            el.style.left = `${rx}px`;
            el.style.top = `${ry}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        setInterval(() => {
            if(gameState.autoRate > 0) {
                gameState.iq += gameState.autoRate;
                updateUI();
            }
            if(Math.random() < 0.02 && document.getElementById('btnMathBonus').style.display !== 'block') {
                spawnBonus();
            }
        }, 1000);

        // Bonus
        let bonusTimer;
        function spawnBonus() {
            const b = document.getElementById('btnMathBonus');
            b.style.display = 'block';
            if(bonusTimer) clearTimeout(bonusTimer);
            bonusTimer = setTimeout(() => b.style.display = 'none', 5000);
        }

        function showMathProblem() {
            document.getElementById('btnMathBonus').style.display = 'none';
            const diff = Math.ceil(Math.sqrt(gameState.clickPower));
            const n1 = Math.floor(Math.random()*15*diff)+5;
            const n2 = Math.floor(Math.random()*15*diff)+5;
            const correct = n1 + n2; 
            
            document.getElementById('mathQuestion').innerText = `${n1} + ${n2} = ?`;
            
            const opts = [correct];
            while(opts.length < 3) {
                let r = correct + Math.floor((Math.random()-0.5)*20);
                if(r !== correct && !opts.includes(r)) opts.push(r);
            }
            opts.sort(()=>Math.random()-0.5);

            const div = document.getElementById('mathOptions');
            div.innerHTML = '';
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = o;
                btn.onclick = () => {
                    document.getElementById('modalOverlay').style.display = 'none';
                    if(o === correct) {
                        const reward = gameState.clickPower * 150 + gameState.autoRate * 60;
                        gameState.iq += Math.max(200, reward);
                        updateUI();
                        if(isPlaying) playNote(523.25 * 2, audioCtx.currentTime); // Sonido de victoria agudo
                    }
                };
                div.appendChild(btn);
            });
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        updateUI();
    </script>
</body>
</html>
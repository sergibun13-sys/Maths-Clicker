<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maths Clicker: Rebirth Evolution</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #3b82f6;
            --accent: #10b981;
            --gold: #fbbf24;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --card-bg: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* Scrollbar invisible para sensaci√≥n de App */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            color: var(--text-main);
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        #mathCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
        }

        /* LAYOUT PRINCIPAL RESPONSIVE */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            width: 100%; height: 100vh;
            position: relative; z-index: 1;
        }

        .game-panel {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; padding: 20px;
            height: 100%;
        }

        .shop-panel {
            background: rgba(15, 23, 42, 0.9); /* Restaurado a 0.9 */
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            height: 100vh; display: flex; flex-direction: column;
            width: 100%;
        }

        /* MEDIA QUERIES PARA M√ìVIL HORIZONTAL */
        @media (max-width: 950px) {
            .main-layout {
                grid-template-columns: 1fr 1fr; /* Mitad y mitad en m√≥vil horizontal */
            }
            
            .score-hud {
                padding: 15px 20px !important;
                min-width: auto !important;
                width: 95%;
                margin-bottom: 20px !important;
            }
            
            #score { font-size: 2.5rem !important; }
            
            .brain-btn-container {
                width: 220px !important;
                height: 220px !important;
            }
            
            #btnClick {
                width: 180px !important;
                height: 180px !important;
            }
            
            #btnClick span.icon { font-size: 3.5rem !important; }
            #btnClick span.text { font-size: 1rem !important; }

            .shop-header { padding: 15px !important; }
            .shop-title { font-size: 1.1rem !important; }
            
            .upgrade-card { padding: 8px !important; gap: 8px !important; }
            .icon-box { width: 32px !important; height: 32px !important; font-size: 1.1rem !important; }
            .card-info h4 { font-size: 0.85rem !important; }
            .card-info p { font-size: 0.7rem !important; }
        }

        /* HUD & SCORE */
        .score-hud {
            text-align: center;
            background: rgba(15, 23, 42, 0.7); /* Restaurado a 0.7 */
            backdrop-filter: blur(12px);
            padding: 25px 40px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 320px;
            margin-bottom: 30px;
            transition: transform 0.1s;
        }
        
        #score {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(to right, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            display: flex; align-items: baseline; justify-content: center; gap: 10px;
        }
        
        #score small { font-size: 1.2rem; -webkit-text-fill-color: rgba(255,255,255,0.4); }

        .frenzy-wrapper { width: 100%; margin-top: 15px; }
        .frenzy-container {
            width: 100%; height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #frenzyBar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #f59e0b, #ef4444);
            transition: width 0.1s linear;
            box-shadow: 0 0 15px #f59e0b;
        }

        #frenzyLabel {
            font-size: 0.75rem; margin-top: 6px; color: #f59e0b; font-weight: 700;
            height: 16px; opacity: 0; transition: opacity 0.3s; letter-spacing: 1px;
        }

        /* BOT√ìN CEREBRO */
        .brain-btn-container {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
        }

        #btnClick {
            width: 240px; height: 240px; border-radius: 50%;
            border: none;
            background: radial-gradient(circle at 35% 35%, #60a5fa, #2563eb, #1e40af);
            box-shadow: 
                inset -10px -10px 20px rgba(0,0,0,0.5),
                inset 10px 10px 20px rgba(255,255,255,0.4),
                0 0 0 8px rgba(37, 99, 235, 0.2),
                0 20px 60px rgba(0,0,0,0.6);
            cursor: pointer; z-index: 10;
            transition: transform 0.05s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            outline: none; -webkit-tap-highlight-color: transparent;
        }

        #btnClick:active { transform: scale(0.92); }
        .frenzy-active #btnClick { box-shadow: 0 0 60px rgba(245, 158, 11, 0.4), inset 0 0 30px #fbbf24; animation: pulseFrenzy 1s infinite; }
        @keyframes pulseFrenzy { 0% {box-shadow: 0 0 40px rgba(245, 158, 11, 0.4);} 50% {box-shadow: 0 0 70px rgba(245, 158, 11, 0.7);} 100% {box-shadow: 0 0 40px rgba(245, 158, 11, 0.4);} }

        #btnClick span.icon { font-size: 4.5rem; display: block; margin-bottom: 5px; pointer-events: none; }
        #btnClick span.text { font-size: 1.2rem; font-weight: 800; letter-spacing: 2px; pointer-events: none; }
        #clickPowerText {
            background: rgba(0,0,0,0.3); padding: 4px 12px; border-radius: 20px;
            font-size: 0.8rem; margin-top: 8px; pointer-events: none;
        }

        /* TIENDA */
        .shop-header {
            padding: 20px; background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }

        .shop-title { font-size: 1.3rem; font-weight: 800; color: white; }
        
        .rebirth-stats {
            font-size: 0.8rem; color: var(--gold); background: rgba(251, 191, 36, 0.15);
            padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3);
            font-weight: 700;
        }

        .shop-content { 
            flex: 1; overflow-y: scroll; padding: 0 15px 80px 15px; /* Padding bottom extra para m√≥viles */
            -webkit-overflow-scrolling: touch;
        }

        .section-header {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--primary); margin: 20px 0 10px 0; font-weight: 700;
            padding-left: 10px; border-left: 3px solid var(--primary);
            background: rgba(59, 130, 246, 0.1); padding: 5px 10px; border-radius: 0 4px 4px 0;
        }

        .upgrade-card {
            background: var(--card-bg); border-radius: 12px; padding: 12px;
            margin-bottom: 8px; display: grid; grid-template-columns: auto 1fr auto;
            gap: 12px; align-items: center; cursor: pointer; transition: 0.1s;
            border: 1px solid transparent; opacity: 0.7;
        }

        .upgrade-card:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .upgrade-card.affordable { border-color: rgba(16, 185, 129, 0.4); opacity: 1; }
        .upgrade-card.locked { pointer-events: none; filter: grayscale(1); opacity: 0.3; }

        .icon-box {
            width: 42px; height: 42px; background: rgba(255, 255, 255, 0.05);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem;
        }

        .card-info h4 { margin: 0; font-size: 0.9rem; display: flex; gap: 8px; align-items: center; color: #e2e8f0; }
        .lvl-badge { font-size: 0.65rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; color: #94a3b8; }
        .card-info p { margin: 2px 0 0 0; color: #64748b; font-size: 0.75rem; }

        .btn-buy {
            background: #334155; color: #94a3b8; border: none; padding: 6px 10px;
            border-radius: 8px; font-family: 'JetBrains Mono', monospace;
            font-weight: 700; min-width: 60px; text-align: right; font-size: 0.8rem;
        }
        .affordable .btn-buy { background: var(--accent); color: #064e3b; box-shadow: 0 0 10px rgba(16, 185, 129, 0.2); }

        /* UI FLOTANTE */
        #btnRebirth {
            position: absolute; top: 20px; right: 20px; z-index: 50;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #451a03; border: none; padding: 8px 16px; border-radius: 12px;
            font-weight: 800; cursor: pointer; display: none; font-size: 0.8rem;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            animation: bounceIn 0.5s;
        }

        #btnMusic {
            position: absolute; top: 20px; left: 20px; width: 40px; height: 40px;
            border-radius: 12px; background: rgba(30,41,59,0.6); color: white;
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer; z-index: 50;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }

        #btnMathBonus {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white; padding: 8px 20px; border-radius: 50px; border:none;
            font-weight: 800; display: none; box-shadow: 0 0 20px rgba(245, 158, 11, 0.5); 
            z-index: 200; cursor: pointer; font-size: 0.9rem;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {transform: translateX(-50%) scale(1);} 50% {transform: translateX(-50%) scale(1.05);} 100% {transform: translateX(-50%) scale(1);} }

        .float-number {
            position: absolute; font-family: 'JetBrains Mono', monospace;
            font-weight: 800; font-size: 1.2rem; pointer-events: none; color: var(--primary);
            animation: floatUp 0.8s ease-out forwards; z-index: 100; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .float-number.crit { color: #f59e0b; font-size: 1.6rem; text-shadow: 0 0 10px rgba(245,158,11,0.5); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.1); opacity: 0; } }
        @keyframes bounceIn { 0%{transform:scale(0); opacity:0;} 80%{transform:scale(1.1);} 100%{transform:scale(1); opacity:1;} }

        /* MODALES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #1e293b; padding: 25px; border-radius: 24px; text-align: center;
            width: 85%; max-width: 400px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .option-btn { 
            background: #334155; color: white; border: none; padding: 15px; 
            border-radius: 12px; font-size: 1.3rem; cursor: pointer; font-family: 'JetBrains Mono';
            transition: background 0.2s;
        }
        .option-btn:active { background: var(--primary); }
        
        .confirm-btn {
            background: var(--gold); color: #451a03; border: none; padding: 16px;
            border-radius: 12px; font-weight: 800; width: 100%; margin-top: 20px; cursor: pointer; font-size: 1rem;
        }
    </style>
</head>

<body>
    <canvas id="mathCanvas"></canvas>

    <div class="main-layout">
        <div class="game-panel">
            <button id="btnMusic" onclick="toggleMusic()">üîá</button>
            <button id="btnRebirth" onclick="openRebirthModal()">üéì GRADUARSE</button>
            <button id="btnMathBonus" onclick="showMathProblem()">üéÅ DESAF√çO (+25%)</button>

            <div class="score-hud">
                <div id="score" class="mono">0<small>IQ</small></div>
                <div id="rate" class="mono" style="color:var(--text-muted); font-size:0.8rem; margin-top:5px;">
                    <span id="rateNum">0</span> IQ/seg
                </div>

                <div class="frenzy-wrapper">
                    <div class="frenzy-container">
                        <div id="frenzyBar"></div>
                    </div>
                    <div id="frenzyLabel" class="mono">‚ö° FLOW STATE: x2 BONUS ‚ö°</div>
                </div>
            </div>

            <div class="brain-btn-container">
                <button id="btnClick" onmousedown="handleManualClick(event)" ontouchstart="handleManualClick(event)">
                    <span class="icon">üß†</span>
                    <span class="text">ESTUDIAR</span>
                    <span id="clickPowerText" class="mono">+1 IQ</span>
                </button>
            </div>
        </div>

        <div class="shop-panel">
            <div class="shop-header">
                <div class="shop-title">üìö Librer√≠a</div>
                <div id="rebirthBadge" class="rebirth-stats" style="display:none">0 üéì</div>
            </div>
            <div class="shop-content">
                <div class="section-header">Mejoras de Click</div>
                <div id="clickUpgradesList"></div>
                <div class="section-header">Mejoras Autom√°ticas</div>
                <div id="autoUpgradesList"></div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="mathModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin:0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">Desaf√≠o R√°pido</h3>
            <p id="mathQuestion" class="mono" style="font-size: 2.2rem; margin: 25px 0; color: white;">¬ø?</p>
            <div id="mathOptions" class="option-grid"></div>
        </div>
    </div>

    <div id="rebirthModal" class="modal-overlay">
        <div class="modal-content" style="border: 2px solid var(--gold);">
            <h2 style="color:var(--gold); margin-top:0;">üéì GRADUACI√ìN</h2>
            <p style="font-size:0.9rem; color:#cbd5e1;">Reinicia tu IQ y mejoras actuales para obtener un multiplicador permanente.</p>
            
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; margin:20px 0; text-align: left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Bonus Actual:</span>
                    <span class="mono" style="color:var(--accent)">x<span id="currentMult">1.0</span></span>
                </div>
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem;">
                    <span>Nuevo Bonus:</span>
                    <span class="mono" style="color:var(--gold)">x<span id="nextMult">1.5</span></span>
                </div>
            </div>

            <p class="mono" style="font-size:0.9rem; color:#94a3b8;">Requisito: <span id="rebirthCost">1M</span> IQ</p>
            
            <button id="btnConfirmRebirth" class="confirm-btn" onclick="doRebirth()">ACEPTAR T√çTULO</button>
            <button class="confirm-btn" style="background:transparent; border:1px solid #475569; color:#94a3b8; margin-top:10px; padding: 12px;" onclick="document.getElementById('rebirthModal').style.display='none'">Cancelar</button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE MEJORAS
        const PRICE_SCALE = 1.14;

        const upgradesConfig = [
            // --- CLICK UPGRADES ---
            { id: 'c1', type: 'click', name: 'L√°piz HB', icon: '‚úèÔ∏è', basePrice: 15, power: 1 },
            { id: 'c2', type: 'click', name: 'Subrayador', icon: 'üñçÔ∏è', basePrice: 80, power: 5 },
            { id: 'c3', type: 'click', name: 'Regla T', icon: 'üìè', basePrice: 350, power: 15 },
            { id: 'c4', type: 'click', name: 'Calculadora', icon: 'üìü', basePrice: 1200, power: 40 },
            { id: 'c5', type: 'click', name: 'Libro F√≥rmulas', icon: 'üìò', basePrice: 5000, power: 100 },
            { id: 'c6', type: 'click', name: 'Microscopio', icon: 'üî¨', basePrice: 20000, power: 300 },
            { id: 'c7', type: 'click', name: 'Superordenador', icon: 'üñ•Ô∏è', basePrice: 80000, power: 1000 },
            { id: 'c8', type: 'click', name: 'Chip Cognitivo', icon: 'üíæ', basePrice: 350000, power: 4500 },
            { id: 'c9', type: 'click', name: 'Enlace Neural', icon: 'üîó', basePrice: 1500000, power: 12000 },
            { id: 'c10', type: 'click', name: 'ADN Sint√©tico', icon: 'üß¨', basePrice: 8000000, power: 35000 },
            { id: 'c11', type: 'click', name: 'IA Predictiva', icon: 'ü§ñ', basePrice: 50000000, power: 100000 },
            { id: 'c12', type: 'click', name: 'Nube Mental', icon: '‚òÅÔ∏è', basePrice: 300000000, power: 450000 },
            { id: 'c13', type: 'click', name: 'Qubits Org√°nicos', icon: 'üí†', basePrice: 1500000000, power: 1500000 },
            { id: 'c14', type: 'click', name: 'Cerebro Matriz', icon: 'üåê', basePrice: 10000000000, power: 5000000 },
            { id: 'c15', type: 'click', name: 'Omnisciencia', icon: 'üëÅÔ∏è', basePrice: 80000000000, power: 20000000 },
            // NUEVOS CLICK
            { id: 'c16', type: 'click', name: 'Salto Cu√°ntico', icon: 'üí´', basePrice: 500000000000, power: 150000000 },
            { id: 'c17', type: 'click', name: 'Teor√≠a de Cuerdas', icon: 'üéª', basePrice: 3500000000000, power: 800000000 },
            { id: 'c18', type: 'click', name: 'Materia Oscura', icon: '‚ö´', basePrice: 25000000000000, power: 5000000000 },
            { id: 'c19', type: 'click', name: 'Control Tiempo', icon: '‚è≥', basePrice: 200000000000000, power: 45000000000 },
            { id: 'c20', type: 'click', name: 'Ecuaci√≥n Divina', icon: 'üî±', basePrice: 2000000000000000, power: 500000000000 },

            // --- AUTO UPGRADES ---
            { id: 'a1', type: 'auto', name: 'Notas Adhesivas', icon: 'üóíÔ∏è', basePrice: 25, power: 1 },
            { id: 'a2', type: 'auto', name: 'Apuntes Prestados', icon: 'üìë', basePrice: 200, power: 5 },
            { id: 'a3', type: 'auto', name: 'Grupo de Estudio', icon: 'üë•', basePrice: 1100, power: 18 },
            { id: 'a4', type: 'auto', name: 'Tutor Privado', icon: 'üë®‚Äçüè´', basePrice: 5000, power: 60 },
            { id: 'a5', type: 'auto', name: 'Curso Online', icon: 'üíª', basePrice: 25000, power: 250 },
            { id: 'a6', type: 'auto', name: 'Biblioteca', icon: 'üèõÔ∏è', basePrice: 120000, power: 1000 },
            { id: 'a7', type: 'auto', name: 'Centro I+D', icon: 'üè¢', basePrice: 600000, power: 4500 },
            { id: 'a8', type: 'auto', name: 'Laboratorio Alfa', icon: '‚öóÔ∏è', basePrice: 3500000, power: 20000 },
            { id: 'a9', type: 'auto', name: 'Uni Global', icon: 'üéì', basePrice: 20000000, power: 85000 },
            { id: 'a10', type: 'auto', name: 'Santuario Zen', icon: 'üßò', basePrice: 150000000, power: 350000 },
            { id: 'a11', type: 'auto', name: 'Colisionador', icon: '‚öõÔ∏è', basePrice: 800000000, power: 1500000 },
            { id: 'a12', type: 'auto', name: 'Sat√©lite Edu', icon: 'üõ∞Ô∏è', basePrice: 5000000000, power: 6000000 },
            { id: 'a13', type: 'auto', name: 'Academia Espacial', icon: 'ü™ê', basePrice: 40000000000, power: 25000000 },
            { id: 'a14', type: 'auto', name: 'Mente Enjambre', icon: 'üß†', basePrice: 350000000000, power: 120000000 },
            { id: 'a15', type: 'auto', name: 'Simulaci√≥n Total', icon: 'üåå', basePrice: 3000000000000, power: 600000000 },
            // NUEVOS AUTO
            { id: 'a16', type: 'auto', name: 'Universo Bolsillo', icon: 'üîÆ', basePrice: 35000000000000, power: 3000000000 },
            { id: 'a17', type: 'auto', name: 'Red Multiversal', icon: 'üï∏Ô∏è', basePrice: 400000000000000, power: 20000000000 },
            { id: 'a18', type: 'auto', name: 'Civilizaci√≥n V', icon: 'üõ∏', basePrice: 5000000000000000, power: 150000000000 },
            { id: 'a19', type: 'auto', name: 'Matem√°tica Pura', icon: '‚ôæÔ∏è', basePrice: 70000000000000000, power: 800000000000 },
            { id: 'a20', type: 'auto', name: 'El Programador', icon: 'üë®‚Äçüíª', basePrice: 999000000000000000, power: 5000000000000 },
        ];

        let gameState = {
            iq: 0,
            clickPower: 1,
            autoRate: 0,
            rebirths: 0,
            upgrades: {}
        };

        let frenzy = { val: 0, max: 100, active: false, timer: 0, dur: 10000 };
        let audioCtx = null;
        let isMuted = true;
        let mathBonus = 0; // % acumulado de bonos temporales

        const canvas = document.getElementById('mathCanvas');
        const ctx = canvas.getContext('2d');
        let canvasW, canvasH, particles = [];

        function init() {
            upgradesConfig.forEach(u => gameState.upgrades[u.id] = 0);
            initShop();
            recalc();
            requestAnimationFrame(gameLoop);
            initParticles();
            requestAnimationFrame(animParticles);
        }

        function format(n) {
            if (n === Infinity) return "INFINITO";
            if (n >= 1e33) return (n/1e33).toFixed(2) + "D"; // Decillon
            if (n >= 1e30) return (n/1e30).toFixed(2) + "N"; // Nonillon
            if (n >= 1e27) return (n/1e27).toFixed(2) + "O"; // Octillon
            if (n >= 1e24) return (n/1e24).toFixed(2) + "Sp"; // Septillon
            if (n >= 1e21) return (n/1e21).toFixed(2) + "Sx"; // Sextillon
            if (n >= 1e18) return (n/1e18).toFixed(2) + "Qi"; // Quintillon
            if (n >= 1e15) return (n/1e15).toFixed(2) + "Q";
            if (n >= 1e12) return (n/1e12).toFixed(2) + "T";
            if (n >= 1e9) return (n/1e9).toFixed(2) + "B";
            if (n >= 1e6) return (n/1e6).toFixed(2) + "M";
            if (n >= 1e3) return (n/1e3).toFixed(1) + "k";
            return Math.floor(n).toLocaleString();
        }

        function getRebirthMult() { return 1 + (gameState.rebirths * 0.5); }
        function getRebirthCost() { return 1000000 * Math.pow(15, gameState.rebirths); } // Costo escala m√°s fuerte

        function recalc() {
            let cp = 1, ar = 0;
            const mult = getRebirthMult() * (frenzy.active ? 2 : 1);

            upgradesConfig.forEach(u => {
                const count = gameState.upgrades[u.id];
                if(u.type === 'click') cp += u.power * count;
                else ar += u.power * count;
            });

            gameState.clickPower = cp * mult;
            gameState.autoRate = ar * mult;

            document.getElementById('rateNum').innerText = format(gameState.autoRate);
            document.getElementById('clickPowerText').innerText = `+${format(gameState.clickPower)} IQ` + (frenzy.active ? " (x2)" : "");
            
            if(gameState.rebirths > 0) {
                const badge = document.getElementById('rebirthBadge');
                badge.style.display = 'block';
                badge.innerText = `${gameState.rebirths} üéì (x${getRebirthMult().toFixed(1)})`;
            }
        }

        function getPrice(u) { return Math.floor(u.basePrice * Math.pow(PRICE_SCALE, gameState.upgrades[u.id])); }

        function initShop() {
            const cList = document.getElementById('clickUpgradesList');
            const aList = document.getElementById('autoUpgradesList');
            upgradesConfig.forEach(u => {
                const el = document.createElement('div');
                el.className = 'upgrade-card';
                el.id = `upg-${u.id}`;
                el.onclick = () => buy(u.id);
                el.innerHTML = `
                    <div class="icon-box">${u.icon}</div>
                    <div class="card-info">
                        <h4>${u.name} <span class="lvl-badge" id="lvl-${u.id}">Lvl.0</span></h4>
                        <p id="pow-${u.id}">+${format(u.power)}</p>
                    </div>
                    <button class="btn-buy" id="price-${u.id}">${format(u.basePrice)}</button>
                `;
                (u.type === 'click' ? cList : aList).appendChild(el);
            });
            updateShopTexts();
        }

        function updateShopTexts() {
            const mult = getRebirthMult() * (frenzy.active ? 2 : 1);
            upgradesConfig.forEach(u => {
                document.getElementById(`lvl-${u.id}`).innerText = `Lvl.${gameState.upgrades[u.id]}`;
                document.getElementById(`price-${u.id}`).innerText = format(getPrice(u));
                document.getElementById(`pow-${u.id}`).innerText = `+${format(u.power * mult)} ${u.type==='click'?'Click':'IQ/s'}`;
            });
        }

        function buy(id) {
            const u = upgradesConfig.find(x => x.id === id);
            const price = getPrice(u);
            if(gameState.iq >= price) {
                gameState.iq -= price;
                gameState.upgrades[id]++;
                playSound(400 + Math.random()*100, 'triangle');
                recalc();
                updateShopTexts();
            }
        }

        function handleManualClick(e) {
            // Prevenir doble disparo en algunos dispositivos t√°ctiles
            if(e.type === 'touchstart') e.preventDefault(); 
            
            tryAudio();
            
            if(!frenzy.active) {
                frenzy.val = Math.min(frenzy.max, frenzy.val + 3);
                if(frenzy.val >= frenzy.max) startFrenzy();
            }

            gameState.iq += gameState.clickPower;
            
            let x, y;
            if (e.changedTouches) { 
                x = e.changedTouches[0].clientX; 
                y = e.changedTouches[0].clientY; 
            } else { 
                x = e.clientX; 
                y = e.clientY; 
            }
            spawnFloat(x, y, gameState.clickPower, frenzy.active);
            playSound(300 + Math.random()*200);
        }

        function startFrenzy() {
            frenzy.active = true;
            frenzy.timer = frenzy.dur;
            document.body.classList.add('frenzy-active');
            document.getElementById('frenzyLabel').style.opacity = '1';
            recalc();
            updateShopTexts();
            playSound(600, 'square');
        }

        function openRebirthModal() {
            const cost = getRebirthCost();
            document.getElementById('rebirthCost').innerText = format(cost);
            document.getElementById('currentMult').innerText = getRebirthMult().toFixed(1);
            document.getElementById('nextMult').innerText = (getRebirthMult() + 0.5).toFixed(1);
            
            const btn = document.getElementById('btnConfirmRebirth');
            if(gameState.iq >= cost) {
                btn.disabled = false; btn.style.opacity = 1; btn.innerText = "ACEPTAR T√çTULO";
            } else {
                btn.disabled = true; btn.style.opacity = 0.5; btn.innerText = "IQ INSUFICIENTE";
            }
            document.getElementById('rebirthModal').style.display = 'flex';
        }

        function doRebirth() {
            if(gameState.iq >= getRebirthCost()) {
                gameState.rebirths++;
                gameState.iq = 0;
                upgradesConfig.forEach(u => gameState.upgrades[u.id] = 0);
                document.getElementById('rebirthModal').style.display = 'none';
                recalc();
                updateShopTexts();
                playSound(800, 'square');
                spawnFloat(window.innerWidth/2, window.innerHeight/2, "GRADUADO!", true);
            }
        }

        function spawnFloat(x, y, val, isCrit) {
            const el = document.createElement('div');
            el.className = `float-number ${isCrit ? 'crit' : ''}`;
            el.innerText = typeof val === 'string' ? val : `+${format(val)}`;
            // Ajuste para que no salga de pantalla
            const safeX = Math.min(window.innerWidth - 50, Math.max(20, x));
            el.style.left = `${safeX}px`; 
            el.style.top = `${y - 40}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function tryAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(freq, type='sine') {
            if(isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function toggleMusic() { tryAudio(); isMuted = !isMuted; document.getElementById('btnMusic').innerText = isMuted ? 'üîá' : 'üîä'; }

        function showMathProblem() {
            document.getElementById('btnMathBonus').style.display = 'none';
            // Dificultad basada en rebirths
            const max = 20 + (gameState.rebirths * 50);
            const n1 = Math.floor(Math.random()*max)+10;
            const n2 = Math.floor(Math.random()*max)+10;
            const ans = n1 + n2;
            
            document.getElementById('mathQuestion').innerText = `${n1} + ${n2} = ?`;
            const container = document.getElementById('mathOptions'); container.innerHTML = '';
            
            let opts = [ans]; 
            while(opts.length < 4) { 
                let r = ans + (Math.floor(Math.random()*20)-10); 
                if(r>0 && !opts.includes(r)) opts.push(r); 
            }
            
            opts.sort(() => Math.random() - 0.5).forEach(o => {
                const b = document.createElement('button'); 
                b.className = 'option-btn'; 
                b.innerText = o;
                
                // Evento Touch para m√≥viles
                const handleAnswer = (e) => {
                    e.preventDefault();
                    document.getElementById('mathModal').style.display = 'none';
                    if(o === ans) {
                        const reward = Math.max(500, gameState.iq * 0.30); // 30% del IQ actual
                        gameState.iq += reward; 
                        spawnFloat(window.innerWidth/2, window.innerHeight/2, "EXCELENTE!", true);
                        playSound(1200, 'triangle');
                    } else {
                        playSound(150, 'sawtooth');
                    }
                };

                b.onclick = handleAnswer;
                container.appendChild(b);
            });
            document.getElementById('mathModal').style.display = 'flex';
        }

        let lastTime = performance.now();
        function gameLoop(now) {
            const dt = now - lastTime; lastTime = now;
            if(gameState.autoRate > 0) gameState.iq += (gameState.autoRate * (dt / 1000));
            
            if(frenzy.active) {
                frenzy.timer -= dt;
                document.getElementById('frenzyBar').style.width = (frenzy.timer / frenzy.dur * 100) + "%";
                if(frenzy.timer <= 0) {
                    frenzy.active = false; frenzy.val = 0;
                    document.body.classList.remove('frenzy-active');
                    document.getElementById('frenzyLabel').style.opacity = '0';
                    recalc(); updateShopTexts();
                }
            } else if(frenzy.val > 0) {
                frenzy.val -= (dt/1000)*8; // Cae m√°s r√°pido
                document.getElementById('frenzyBar').style.width = Math.max(0, frenzy.val) + "%";
            }

            document.getElementById('score').innerHTML = `${format(gameState.iq)}<small>IQ</small>`;
            
            // Optimizaci√≥n: Solo actualizar clases si cambia estado de asequible
            upgradesConfig.forEach(u => {
                const el = document.getElementById(`upg-${u.id}`);
                const affordable = gameState.iq >= getPrice(u);
                if(affordable && !el.classList.contains('affordable')) el.classList.add('affordable');
                else if(!affordable && el.classList.contains('affordable')) el.classList.remove('affordable');
            });

            if(gameState.iq >= getRebirthCost() * 0.1 || gameState.rebirths > 0) document.getElementById('btnRebirth').style.display = 'block';

            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() { 
            canvasW = canvas.width = window.innerWidth; 
            canvasH = canvas.height = window.innerHeight; 
        }

        window.addEventListener('resize', resizeCanvas);

        function initParticles() {
            resizeCanvas();
            particles = [];
            for(let i=0; i<35; i++) {
                particles.push({
                    x: Math.random() * canvasW, 
                    y: Math.random() * canvasH, 
                    s: ['œÄ','‚àö','‚àë','‚à´','‚àû','‚â†','‚âà'][Math.floor(Math.random()*7)], 
                    v: 0.2 + Math.random() * 0.8
                });
            }
        }

        function animParticles() {
            ctx.clearRect(0, 0, canvasW, canvasH); 
            ctx.font = '20px monospace'; 
            ctx.fillStyle = 'rgba(56, 189, 248, 0.2)'; /* Restaurado a 0.2 */
            particles.forEach(p => { 
                p.y -= p.v; 
                if(p.y < -20) p.y = canvasH + 20; 
                ctx.fillText(p.s, p.x, p.y); 
            });
            requestAnimationFrame(animParticles);
        }

        init();
        
        // Loop del bonus
        setInterval(() => {
            const b = document.getElementById('btnMathBonus'); 
            b.style.display = 'block';
            playSound(1000, 'sine'); // Aviso sonoro sutil
            setTimeout(() => b.style.display = 'none', 8000);
        }, 60000); // Cada minuto
    </script>
</body>
</html>

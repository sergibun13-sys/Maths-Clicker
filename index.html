<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Clicker: Rebirth Evolution</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #3b82f6;
            --accent: #10b981;
            --gold: #fbbf24;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --card-bg: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            color: var(--text-main);
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        #mathCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 420px;
            width: 100%; height: 100vh;
            max-width: 1800px; margin: 0 auto;
            position: relative; z-index: 1;
        }

        .game-panel {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; padding: 20px;
        }

        .score-hud {
            text-align: center;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            padding: 25px 40px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 320px;
            margin-bottom: 40px;
        }
        
        #score {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(to right, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            display: flex; align-items: baseline; justify-content: center; gap: 10px;
        }
        
        #score small { font-size: 1.2rem; -webkit-text-fill-color: rgba(255,255,255,0.4); }

        .frenzy-wrapper { width: 100%; margin-top: 15px; }
        .frenzy-container {
            width: 100%; height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #frenzyBar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #f59e0b, #ef4444);
            transition: width 0.1s linear;
            box-shadow: 0 0 15px #f59e0b;
        }

        #frenzyLabel {
            font-size: 0.8rem; margin-top: 8px; color: #f59e0b; font-weight: 700;
            height: 20px; opacity: 0; transition: opacity 0.3s; letter-spacing: 1px;
        }

        .brain-btn-container {
            position: relative; width: 320px; height: 320px;
            display: flex; justify-content: center; align-items: center;
        }

        #btnClick {
            width: 260px; height: 260px; border-radius: 50%;
            border: none;
            background: radial-gradient(circle at 35% 35%, #60a5fa, #2563eb, #1e40af);
            box-shadow: 
                inset -10px -10px 20px rgba(0,0,0,0.5),
                inset 10px 10px 20px rgba(255,255,255,0.4),
                0 0 0 8px rgba(37, 99, 235, 0.2),
                0 20px 60px rgba(0,0,0,0.6);
            cursor: pointer; z-index: 10;
            transition: transform 0.05s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }

        #btnClick:active { transform: scale(0.94); }
        .frenzy-active #btnClick { box-shadow: 0 0 60px rgba(245, 158, 11, 0.4), inset 0 0 30px #fbbf24; }

        #btnClick span.icon { font-size: 5rem; display: block; margin-bottom: 5px; }
        #btnClick span.text { font-size: 1.4rem; font-weight: 800; letter-spacing: 2px; }
        #clickPowerText {
            background: rgba(0,0,0,0.3); padding: 4px 12px; border-radius: 20px;
            font-size: 0.9rem; margin-top: 8px;
        }

        .shop-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            height: 100vh; display: flex; flex-direction: column;
        }

        .shop-header {
            padding: 20px; background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
        }

        .shop-title { font-size: 1.4rem; font-weight: 800; color: white; }
        
        .rebirth-stats {
            font-size: 0.8rem; color: var(--gold); background: rgba(251, 191, 36, 0.15);
            padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3);
            font-weight: 700;
        }

        .shop-content { flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; }

        .section-header {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--primary); margin: 25px 0 10px 0; font-weight: 700;
            padding-left: 10px; border-left: 3px solid var(--primary);
        }

        .upgrade-card {
            background: var(--card-bg); border-radius: 12px; padding: 12px;
            margin-bottom: 10px; display: grid; grid-template-columns: auto 1fr auto;
            gap: 12px; align-items: center; cursor: pointer; transition: 0.2s;
            border: 1px solid transparent; opacity: 0.6;
        }

        .upgrade-card:hover { background: rgba(255,255,255,0.08); }
        .upgrade-card.affordable { border-color: rgba(16, 185, 129, 0.4); opacity: 1; }
        .upgrade-card.locked { pointer-events: none; filter: grayscale(1); opacity: 0.3; }

        .icon-box {
            width: 40px; height: 40px; background: rgba(255, 255, 255, 0.05);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem;
        }

        .card-info h4 { margin: 0; font-size: 0.95rem; display: flex; gap: 8px; align-items: center; }
        .lvl-badge { font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
        .card-info p { margin: 4px 0 0 0; color: #94a3b8; font-size: 0.8rem; }

        .btn-buy {
            background: #334155; color: #94a3b8; border: none; padding: 8px 10px;
            border-radius: 8px; font-family: 'JetBrains Mono', monospace;
            font-weight: 700; min-width: 70px; text-align: right; font-size: 0.85rem;
        }
        .affordable .btn-buy { background: var(--accent); color: #064e3b; }

        #btnRebirth {
            position: fixed; top: 20px; right: 440px; z-index: 50;
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #451a03; border: none; padding: 10px 20px; border-radius: 12px;
            font-weight: 800; cursor: pointer; display: none;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            animation: bounceIn 0.5s;
        }

        #btnMusic {
            position: fixed; top: 20px; left: 20px; width: 44px; height: 44px;
            border-radius: 12px; background: rgba(30,41,59,0.8); color: white;
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer; z-index: 50;
        }

        #btnMathBonus {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white; padding: 10px 25px; border-radius: 50px; border:none;
            font-weight: 800; display: none; box-shadow: 0 0 20px rgba(245, 158, 11, 0.5); z-index: 200; cursor: pointer;
        }

        .float-number {
            position: absolute; font-family: 'JetBrains Mono', monospace;
            font-weight: 800; font-size: 1.2rem; pointer-events: none; color: var(--primary);
            animation: floatUp 0.8s ease-out forwards; z-index: 100;
        }
        .float-number.crit { color: #f59e0b; font-size: 1.8rem; text-shadow: 0 0 10px rgba(245,158,11,0.5); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.1); opacity: 0; } }
        @keyframes bounceIn { 0%{transform:scale(0); opacity:0;} 80%{transform:scale(1.1);} 100%{transform:scale(1); opacity:1;} }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #1e293b; padding: 30px; border-radius: 24px; text-align: center;
            width: 90%; max-width: 420px; border: 1px solid rgba(255,255,255,0.1);
        }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .option-btn { background: #334155; color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; }
        
        .confirm-btn {
            background: var(--gold); color: #451a03; border: none; padding: 16px;
            border-radius: 12px; font-weight: 800; width: 100%; margin-top: 20px; cursor: pointer; font-size: 1rem;
        }
    </style>
</head>

<body>
    <canvas id="mathCanvas"></canvas>

    <div class="main-layout">
        <div class="game-panel">
            <button id="btnMusic" onclick="toggleMusic()">üîá</button>
            <button id="btnRebirth" onclick="openRebirthModal()">üéì GRADUARSE</button>

            <div class="score-hud">
                <div id="score" class="mono">0<small>IQ</small></div>
                <div id="rate" class="mono" style="color:var(--text-muted); font-size:0.9rem; margin-top:5px;">
                    <span id="rateNum">0</span> IQ/seg
                </div>

                <div class="frenzy-wrapper">
                    <div class="frenzy-container">
                        <div id="frenzyBar"></div>
                    </div>
                    <div id="frenzyLabel" class="mono">‚ö° FLOW STATE: x2 BONUS ‚ö°</div>
                </div>
            </div>

            <button id="btnMathBonus" onclick="showMathProblem()">üéÅ DESAF√çO (+25%)</button>

            <div class="brain-btn-container">
                <button id="btnClick" onmousedown="handleManualClick(event)" ontouchstart="handleManualClick(event)">
                    <span class="icon">üß†</span>
                    <span class="text">ESTUDIAR</span>
                    <span id="clickPowerText" class="mono">+1 IQ</span>
                </button>
            </div>
        </div>

        <div class="shop-panel">
            <div class="shop-header">
                <div class="shop-title">üìö Librer√≠a</div>
                <div id="rebirthBadge" class="rebirth-stats" style="display:none">0 üéì</div>
            </div>
            <div class="shop-content">
                <div class="section-header">Mejoras de Click</div>
                <div id="clickUpgradesList"></div>
                <div class="section-header">Mejoras Autom√°ticas</div>
                <div id="autoUpgradesList"></div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="mathModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color:var(--primary); margin:0;">üß† BONUS R√ÅPIDO</h2>
            <p id="mathQuestion" class="mono" style="font-size: 2rem; margin: 20px 0;">¬ø?</p>
            <div id="mathOptions" class="option-grid"></div>
        </div>
    </div>

    <div id="rebirthModal" class="modal-overlay">
        <div class="modal-content" style="border: 2px solid var(--gold);">
            <h2 style="color:var(--gold); margin-top:0;">üéì GRADUACI√ìN</h2>
            <p style="font-size:0.9rem; color:#cbd5e1;">Reinicia tu IQ y mejoras actuales para obtener un multiplicador permanente.</p>
            
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; margin:20px 0; text-align: left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Bonus Actual:</span>
                    <span class="mono" style="color:var(--accent)">x<span id="currentMult">1.0</span></span>
                </div>
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem;">
                    <span>Nuevo Bonus:</span>
                    <span class="mono" style="color:var(--gold)">x<span id="nextMult">1.5</span></span>
                </div>
            </div>

            <p class="mono" style="font-size:0.9rem; color:#94a3b8;">Requisito: <span id="rebirthCost">1M</span> IQ</p>
            
            <button id="btnConfirmRebirth" class="confirm-btn" onclick="doRebirth()">ACEPTAR T√çTULO</button>
            <button class="confirm-btn" style="background:transparent; border:1px solid #475569; color:#94a3b8; margin-top:10px;" onclick="document.getElementById('rebirthModal').style.display='none'">Quiz√°s luego</button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE MEJORAS
        const PRICE_SCALE = 1.12;

        const upgradesConfig = [
            { id: 'c1', type: 'click', name: 'L√°piz HB', icon: '‚úèÔ∏è', basePrice: 15, power: 1 },
            { id: 'c2', type: 'click', name: 'Subrayador', icon: 'üñçÔ∏è', basePrice: 80, power: 4 },
            { id: 'c3', type: 'click', name: 'Regla T', icon: 'üìè', basePrice: 250, power: 12 },
            { id: 'c4', type: 'click', name: 'Calculadora', icon: 'üìü', basePrice: 800, power: 35 },
            { id: 'c5', type: 'click', name: 'Libro F√≥rmulas', icon: 'üìò', basePrice: 2000, power: 90 },
            { id: 'c6', type: 'click', name: 'Microscopio', icon: 'üî¨', basePrice: 6000, power: 250 },
            { id: 'c7', type: 'click', name: 'Superordenador', icon: 'üñ•Ô∏è', basePrice: 18000, power: 700 },
            { id: 'c8', type: 'click', name: 'Chip Cognitivo', icon: 'üíæ', basePrice: 50000, power: 1800 },
            { id: 'c9', type: 'click', name: 'Enlace Neural', icon: 'üîó', basePrice: 150000, power: 5000 },
            { id: 'c10', type: 'click', name: 'ADN Sint√©tico', icon: 'üß¨', basePrice: 500000, power: 15000 },
            { id: 'c11', type: 'click', name: 'IA Predictiva', icon: 'ü§ñ', basePrice: 2000000, power: 50000 },
            { id: 'c12', type: 'click', name: 'Nube Mental', icon: '‚òÅÔ∏è', basePrice: 10000000, power: 200000 },
            { id: 'c13', type: 'click', name: 'Qubits Org√°nicos', icon: 'üí†', basePrice: 50000000, power: 800000 },
            { id: 'c14', type: 'click', name: 'Cerebro Matriz', icon: 'üåê', basePrice: 250000000, power: 3000000 },
            { id: 'c15', type: 'click', name: 'Omnisciencia', icon: 'üëÅÔ∏è', basePrice: 1000000000, power: 15000000 },
            { id: 'a1', type: 'auto', name: 'Notas Adhesivas', icon: 'üóíÔ∏è', basePrice: 25, power: 1 },
            { id: 'a2', type: 'auto', name: 'Apuntes Prestados', icon: 'üìë', basePrice: 150, power: 6 },
            { id: 'a3', type: 'auto', name: 'Grupo de Estudio', icon: 'üë•', basePrice: 800, power: 20 },
            { id: 'a4', type: 'auto', name: 'Tutor Privado', icon: 'üë®‚Äçüè´', basePrice: 3000, power: 65 },
            { id: 'a5', type: 'auto', name: 'Curso Online', icon: 'üíª', basePrice: 10000, power: 180 },
            { id: 'a6', type: 'auto', name: 'Biblioteca', icon: 'üèõÔ∏è', basePrice: 35000, power: 500 },
            { id: 'a7', type: 'auto', name: 'Centro I+D', icon: 'üè¢', basePrice: 120000, power: 1500 },
            { id: 'a8', type: 'auto', name: 'Laboratorio Alfa', icon: '‚öóÔ∏è', basePrice: 400000, power: 4500 },
            { id: 'a9', type: 'auto', name: 'Uni Global', icon: 'üéì', basePrice: 1500000, power: 15000 },
            { id: 'a10', type: 'auto', name: 'Santuario Zen', icon: 'üßò', basePrice: 6000000, power: 55000 },
            { id: 'a11', type: 'auto', name: 'Colisionador', icon: '‚öõÔ∏è', basePrice: 25000000, power: 200000 },
            { id: 'a12', type: 'auto', name: 'Sat√©lite Edu', icon: 'üõ∞Ô∏è', basePrice: 120000000, power: 850000 },
            { id: 'a13', type: 'auto', name: 'Academia Espacial', icon: 'ü™ê', basePrice: 600000000, power: 4000000 },
            { id: 'a14', type: 'auto', name: 'Mente Enjambre', icon: 'üß†', basePrice: 3000000000, power: 18000000 },
            { id: 'a15', type: 'auto', name: 'Simulaci√≥n Total', icon: 'üåå', basePrice: 15000000000, power: 100000000 },
        ];

        let gameState = {
            iq: 0,
            clickPower: 1,
            autoRate: 0,
            rebirths: 0,
            upgrades: {}
        };

        let frenzy = { val: 0, max: 100, active: false, timer: 0, dur: 10000 };
        let audioCtx = null;
        let isMuted = true;

        // Variables de Canvas (Declaradas una sola vez aqu√≠)
        const canvas = document.getElementById('mathCanvas');
        const ctx = canvas.getContext('2d');
        let canvasW, canvasH, particles = [];

        function init() {
            upgradesConfig.forEach(u => gameState.upgrades[u.id] = 0);
            initShop();
            recalc();
            requestAnimationFrame(gameLoop);
            initParticles();
            requestAnimationFrame(animParticles);
        }

        function format(n) {
            if (n >= 1e15) return (n/1e15).toFixed(2) + "Q";
            if (n >= 1e12) return (n/1e12).toFixed(2) + "T";
            if (n >= 1e9) return (n/1e9).toFixed(2) + "B";
            if (n >= 1e6) return (n/1e6).toFixed(2) + "M";
            if (n >= 1e3) return (n/1e3).toFixed(1) + "k";
            return Math.floor(n).toLocaleString();
        }

        function getRebirthMult() { return 1 + (gameState.rebirths * 0.5); }
        function getRebirthCost() { return 1000000 * Math.pow(10, gameState.rebirths); }

        function recalc() {
            let cp = 1, ar = 0;
            const mult = getRebirthMult() * (frenzy.active ? 2 : 1);

            upgradesConfig.forEach(u => {
                const count = gameState.upgrades[u.id];
                if(u.type === 'click') cp += u.power * count;
                else ar += u.power * count;
            });

            gameState.clickPower = cp * mult;
            gameState.autoRate = ar * mult;

            document.getElementById('rateNum').innerText = format(gameState.autoRate);
            document.getElementById('clickPowerText').innerText = `+${format(gameState.clickPower)} IQ` + (frenzy.active ? " (x2)" : "");
            
            if(gameState.rebirths > 0) {
                const badge = document.getElementById('rebirthBadge');
                badge.style.display = 'block';
                badge.innerText = `${gameState.rebirths} üéì (x${getRebirthMult().toFixed(1)})`;
            }
        }

        function getPrice(u) { return Math.floor(u.basePrice * Math.pow(PRICE_SCALE, gameState.upgrades[u.id])); }

        function initShop() {
            const cList = document.getElementById('clickUpgradesList');
            const aList = document.getElementById('autoUpgradesList');
            upgradesConfig.forEach(u => {
                const el = document.createElement('div');
                el.className = 'upgrade-card';
                el.id = `upg-${u.id}`;
                el.onclick = () => buy(u.id);
                el.innerHTML = `
                    <div class="icon-box">${u.icon}</div>
                    <div class="card-info">
                        <h4>${u.name} <span class="lvl-badge" id="lvl-${u.id}">Lvl.0</span></h4>
                        <p id="pow-${u.id}">+${format(u.power)}</p>
                    </div>
                    <button class="btn-buy" id="price-${u.id}">${format(u.basePrice)}</button>
                `;
                (u.type === 'click' ? cList : aList).appendChild(el);
            });
            updateShopTexts();
        }

        function updateShopTexts() {
            const mult = getRebirthMult() * (frenzy.active ? 2 : 1);
            upgradesConfig.forEach(u => {
                document.getElementById(`lvl-${u.id}`).innerText = `Lvl.${gameState.upgrades[u.id]}`;
                document.getElementById(`price-${u.id}`).innerText = format(getPrice(u));
                document.getElementById(`pow-${u.id}`).innerText = `+${format(u.power * mult)} ${u.type==='click'?'Click':'IQ/s'}`;
            });
        }

        function buy(id) {
            const u = upgradesConfig.find(x => x.id === id);
            const price = getPrice(u);
            if(gameState.iq >= price) {
                gameState.iq -= price;
                gameState.upgrades[id]++;
                playSound(400 + Math.random()*100, 'triangle');
                recalc();
                updateShopTexts();
            }
        }

        function handleManualClick(e) {
            if(e && e.cancelable) e.preventDefault();
            tryAudio();
            
            if(!frenzy.active) {
                frenzy.val = Math.min(frenzy.max, frenzy.val + 2);
                if(frenzy.val >= frenzy.max) startFrenzy();
            }

            gameState.iq += gameState.clickPower;
            
            let x, y;
            if (e.touches) { x = e.touches[0].clientX; y = e.touches[0].clientY; }
            else { x = e.clientX; y = e.clientY; }
            spawnFloat(x, y, gameState.clickPower, frenzy.active);
            playSound(300 + Math.random()*200);
        }

        function startFrenzy() {
            frenzy.active = true;
            frenzy.timer = frenzy.dur;
            document.body.classList.add('frenzy-active');
            document.getElementById('frenzyLabel').style.opacity = '1';
            recalc();
            updateShopTexts();
            playSound(600, 'square');
        }

        function openRebirthModal() {
            const cost = getRebirthCost();
            document.getElementById('rebirthCost').innerText = format(cost);
            document.getElementById('currentMult').innerText = getRebirthMult().toFixed(1);
            document.getElementById('nextMult').innerText = (getRebirthMult() + 0.5).toFixed(1);
            
            const btn = document.getElementById('btnConfirmRebirth');
            if(gameState.iq >= cost) {
                btn.disabled = false; btn.style.opacity = 1; btn.innerText = "ACEPTAR T√çTULO";
            } else {
                btn.disabled = true; btn.style.opacity = 0.5; btn.innerText = "IQ INSUFICIENTE";
            }
            document.getElementById('rebirthModal').style.display = 'flex';
        }

        function doRebirth() {
            if(gameState.iq >= getRebirthCost()) {
                gameState.rebirths++;
                gameState.iq = 0;
                upgradesConfig.forEach(u => gameState.upgrades[u.id] = 0);
                document.getElementById('rebirthModal').style.display = 'none';
                recalc();
                updateShopTexts();
                playSound(800, 'square');
                spawnFloat(window.innerWidth/2, window.innerHeight/2, "GRADUADO!", true);
            }
        }

        function spawnFloat(x, y, val, isCrit) {
            const el = document.createElement('div');
            el.className = `float-number ${isCrit ? 'crit' : ''}`;
            el.innerText = typeof val === 'string' ? val : `+${format(val)}`;
            el.style.left = `${x}px`; el.style.top = `${y - 40}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function tryAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(freq, type='sine') {
            if(isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function toggleMusic() { tryAudio(); isMuted = !isMuted; document.getElementById('btnMusic').innerText = isMuted ? 'üîá' : 'üîä'; }

        function showMathProblem() {
            document.getElementById('btnMathBonus').style.display = 'none';
            const n1 = Math.floor(Math.random()*50)+10, n2 = Math.floor(Math.random()*50)+10, ans = n1 + n2;
            document.getElementById('mathQuestion').innerText = `${n1} + ${n2} = ?`;
            const container = document.getElementById('mathOptions'); container.innerHTML = '';
            let opts = [ans]; while(opts.length < 4) { let r = ans + (Math.floor(Math.random()*10)-5); if(r>0 && !opts.includes(r)) opts.push(r); }
            opts.sort(() => Math.random() - 0.5).forEach(o => {
                const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = o;
                b.onclick = () => {
                    document.getElementById('mathModal').style.display = 'none';
                    if(o === ans) {
                        const reward = Math.max(100, Math.floor(gameState.iq * 0.25));
                        gameState.iq += reward; spawnFloat(window.innerWidth/2, window.innerHeight/2, reward, true);
                    }
                };
                container.appendChild(b);
            });
            document.getElementById('mathModal').style.display = 'flex';
        }

        let lastTime = performance.now();
        function gameLoop(now) {
            const dt = now - lastTime; lastTime = now;
            if(gameState.autoRate > 0) gameState.iq += (gameState.autoRate * (dt / 1000));
            
            if(frenzy.active) {
                frenzy.timer -= dt;
                document.getElementById('frenzyBar').style.width = (frenzy.timer / frenzy.dur * 100) + "%";
                if(frenzy.timer <= 0) {
                    frenzy.active = false; frenzy.val = 0;
                    document.body.classList.remove('frenzy-active');
                    document.getElementById('frenzyLabel').style.opacity = '0';
                    recalc(); updateShopTexts();
                }
            } else if(frenzy.val > 0) {
                frenzy.val -= (dt/1000)*5;
                document.getElementById('frenzyBar').style.width = Math.max(0, frenzy.val) + "%";
            }

            document.getElementById('score').innerHTML = `${format(gameState.iq)}<small>IQ</small>`;
            
            upgradesConfig.forEach(u => {
                const el = document.getElementById(`upg-${u.id}`);
                if(gameState.iq >= getPrice(u)) el.classList.add('affordable');
                else el.classList.remove('affordable');
            });

            if(gameState.iq >= getRebirthCost() * 0.5 || gameState.rebirths > 0) document.getElementById('btnRebirth').style.display = 'block';

            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() { 
            canvasW = canvas.width = window.innerWidth; 
            canvasH = canvas.height = window.innerHeight; 
        }

        window.addEventListener('resize', resizeCanvas);

        function initParticles() {
            resizeCanvas();
            particles = [];
            for(let i=0; i<30; i++) {
                particles.push({
                    x: Math.random() * canvasW, 
                    y: Math.random() * canvasH, 
                    s: ['œÄ','‚àö','‚àë','‚à´'][Math.floor(Math.random()*4)], 
                    v: 0.5 + Math.random()
                });
            }
        }

        function animParticles() {
            ctx.clearRect(0, 0, canvasW, canvasH); 
            ctx.font = '20px monospace'; 
            ctx.fillStyle = 'rgba(56, 189, 248, 0.2)';
            particles.forEach(p => { 
                p.y -= p.v; 
                if(p.y < -20) p.y = canvasH + 20; 
                ctx.fillText(p.s, p.x, p.y); 
            });
            requestAnimationFrame(animParticles);
        }

        init();
        
        setInterval(() => {
            const b = document.getElementById('btnMathBonus'); b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 10000);
        }, 45000);
    </script>
</body>
</html>
